{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Rahmat%20Fauzi/Documents/Rahmat%20Fauzi/Probation/SCOPS/palm-oil-grading-app/app/api/inference/route.ts"],"sourcesContent":["/**\r\n * Backend Inference API Endpoint\r\n * \r\n * Handles image inference requests from the frontend.\r\n * This endpoint receives base64 image data and returns predictions.\r\n * \r\n * POST /api/inference\r\n * Body: { image: string } - base64 encoded image\r\n * Response: { result: string, confidence: number, predictions: number[] }\r\n */\r\n\r\nimport { NextRequest, NextResponse } from 'next/server'\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const body = await request.json()\r\n    const { image, user_id } = body\r\n\r\n    if (!image || typeof image !== 'string') {\r\n      return NextResponse.json(\r\n        { error: 'Missing or invalid image data' },\r\n        { status: 400 }\r\n      )\r\n    }\r\n\r\n    console.log('[Inference API] Processing inference request...')\r\n    if (user_id) {\r\n      console.log(`[Inference API] User ID: ${user_id}`)\r\n    }\r\n    const startTime = Date.now()\r\n\r\n    // Run inference via Python backend\r\n    const predictions = await runModelInference(image, user_id)\r\n\r\n    const inferenceTime = Date.now() - startTime\r\n    console.log(`[Inference API] Inference completed in ${inferenceTime}ms`)\r\n\r\n    return NextResponse.json({\r\n      result: predictions.result,\r\n      confidence: predictions.confidence,\r\n      predictions: predictions.predictions,\r\n      inferenceTime\r\n    })\r\n\r\n  } catch (error) {\r\n    console.error('[Inference API] Error:', error)\r\n    return NextResponse.json(\r\n      { \r\n        error: 'Inference failed',\r\n        message: error instanceof Error ? error.message : 'Unknown error'\r\n      },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n\r\n/**\r\n * Run model inference via Python backend\r\n * \r\n * Connects to the Python TFLite backend server\r\n * \r\n * @param imageBase64 - Base64 encoded image\r\n * @param userId - User ID for tracking (optional)\r\n * @returns Prediction results\r\n */\r\nasync function runModelInference(imageBase64: string, userId?: number): Promise<{\r\n  result: string\r\n  confidence: number\r\n  predictions: number[]\r\n  saved?: boolean\r\n  history_id?: number\r\n}> {\r\n  try {\r\n    // Python backend URL (can be configured via environment variable)\r\n    const backendUrl = process.env.PYTHON_BACKEND_URL || 'http://localhost:5000'\r\n    \r\n    console.log('[Inference API] Calling Python backend at:', backendUrl)\r\n    \r\n    // Call Python backend with user_id for automatic history saving\r\n    const response = await fetch(`${backendUrl}/api/model/run`, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n      },\r\n      body: JSON.stringify({\r\n        image: imageBase64,\r\n        user_id: userId // Pass user_id to backend\r\n      })\r\n    })\r\n\r\n    if (!response.ok) {\r\n      const errorText = await response.text()\r\n      throw new Error(`Python backend returned ${response.status}: ${errorText}`)\r\n    }\r\n\r\n    const data = await response.json()\r\n    \r\n    if (!data.success) {\r\n      throw new Error(data.error || 'Python backend inference failed')\r\n    }\r\n\r\n    console.log('[Inference API] Python backend response:', {\r\n      label: data.output.label,\r\n      confidence: data.output.confidence,\r\n      inferenceTime: data.inferenceTime,\r\n      saved: data.saved,\r\n      history_id: data.history_id\r\n    })\r\n\r\n    // Return in format expected by frontend\r\n    return {\r\n      result: data.output.label,\r\n      confidence: data.output.confidence,\r\n      predictions: data.output.predictions,\r\n      saved: data.saved,\r\n      history_id: data.history_id\r\n    }\r\n\r\n  } catch (error) {\r\n    console.error('[Inference API] Python backend error:', error)\r\n    throw new Error(\r\n      `Failed to connect to Python backend: ${error instanceof Error ? error.message : 'Unknown error'}`\r\n    )\r\n  }\r\n}\r\n\r\n// Support GET requests for health check\r\nexport async function GET() {\r\n  return NextResponse.json({\r\n    status: 'healthy',\r\n    endpoint: '/api/inference',\r\n    message: 'Inference API is running. Send POST requests with image data.'\r\n  })\r\n}\r\n"],"names":[],"mappings":"AAAA;;;;;;;;;CASC;;;;;;AAED;;AAEO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,KAAK,EAAE,OAAO,EAAE,GAAG;QAE3B,IAAI,CAAC,SAAS,OAAO,UAAU,UAAU;YACvC,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAgC,GACzC;gBAAE,QAAQ;YAAI;QAElB;QAEA,QAAQ,GAAG,CAAC;QACZ,IAAI,SAAS;YACX,QAAQ,GAAG,CAAC,CAAC,yBAAyB,EAAE,SAAS;QACnD;QACA,MAAM,YAAY,KAAK,GAAG;QAE1B,mCAAmC;QACnC,MAAM,cAAc,MAAM,kBAAkB,OAAO;QAEnD,MAAM,gBAAgB,KAAK,GAAG,KAAK;QACnC,QAAQ,GAAG,CAAC,CAAC,uCAAuC,EAAE,cAAc,EAAE,CAAC;QAEvE,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,QAAQ,YAAY,MAAM;YAC1B,YAAY,YAAY,UAAU;YAClC,aAAa,YAAY,WAAW;YACpC;QACF;IAEF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,0BAA0B;QACxC,OAAO,gJAAY,CAAC,IAAI,CACtB;YACE,OAAO;YACP,SAAS,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QACpD,GACA;YAAE,QAAQ;QAAI;IAElB;AACF;AAEA;;;;;;;;CAQC,GACD,eAAe,kBAAkB,WAAmB,EAAE,MAAe;IAOnE,IAAI;QACF,kEAAkE;QAClE,MAAM,aAAa,QAAQ,GAAG,CAAC,kBAAkB,IAAI;QAErD,QAAQ,GAAG,CAAC,8CAA8C;QAE1D,gEAAgE;QAChE,MAAM,WAAW,MAAM,MAAM,GAAG,WAAW,cAAc,CAAC,EAAE;YAC1D,QAAQ;YACR,SAAS;gBACP,gBAAgB;YAClB;YACA,MAAM,KAAK,SAAS,CAAC;gBACnB,OAAO;gBACP,SAAS,OAAO,0BAA0B;YAC5C;QACF;QAEA,IAAI,CAAC,SAAS,EAAE,EAAE;YAChB,MAAM,YAAY,MAAM,SAAS,IAAI;YACrC,MAAM,IAAI,MAAM,CAAC,wBAAwB,EAAE,SAAS,MAAM,CAAC,EAAE,EAAE,WAAW;QAC5E;QAEA,MAAM,OAAO,MAAM,SAAS,IAAI;QAEhC,IAAI,CAAC,KAAK,OAAO,EAAE;YACjB,MAAM,IAAI,MAAM,KAAK,KAAK,IAAI;QAChC;QAEA,QAAQ,GAAG,CAAC,4CAA4C;YACtD,OAAO,KAAK,MAAM,CAAC,KAAK;YACxB,YAAY,KAAK,MAAM,CAAC,UAAU;YAClC,eAAe,KAAK,aAAa;YACjC,OAAO,KAAK,KAAK;YACjB,YAAY,KAAK,UAAU;QAC7B;QAEA,wCAAwC;QACxC,OAAO;YACL,QAAQ,KAAK,MAAM,CAAC,KAAK;YACzB,YAAY,KAAK,MAAM,CAAC,UAAU;YAClC,aAAa,KAAK,MAAM,CAAC,WAAW;YACpC,OAAO,KAAK,KAAK;YACjB,YAAY,KAAK,UAAU;QAC7B;IAEF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,yCAAyC;QACvD,MAAM,IAAI,MACR,CAAC,qCAAqC,EAAE,iBAAiB,QAAQ,MAAM,OAAO,GAAG,iBAAiB;IAEtG;AACF;AAGO,eAAe;IACpB,OAAO,gJAAY,CAAC,IAAI,CAAC;QACvB,QAAQ;QACR,UAAU;QACV,SAAS;IACX;AACF"}}]
}